pipeline {

    agent {
       kubernetes {
       inheritFrom 'model-ct'
       }
    }

    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag to deploy')
    }

    environment {
        IMAGE_NAME = 'asif1993/second_ml'
    }

    stages {
        stage('Checkout') {
            steps { 
                git branch: 'main', credentialsId: 'git-cred', url: 'https://github.com/AsifShaikh93/first_ml_k8s.git' 
            }
        }
    
        stage('Edit and Push Manifest') {
            steps {
                script {
                    def tagToDeploy = params.IMAGE_TAG 
                    echo "CD: updating deploy.yaml to tag = ${tagToDeploy}"

                    withCredentials([usernamePassword(credentialsId: 'git-cred', usernameVariable: 'user', passwordVariable: 'pass')]) {
                        sh """
                        sed -i "s#^\\( *image: \\).*#\\1${IMAGE_NAME}:${tagToDeploy}#" k8s/deploy.yaml
                        git config user.name "Jenkins CD Bot"
                        git config user.email "jenkins-cd@local"
                        git remote set-url origin https://$user:$pass@github.com/AsifShaikh93/first_ml_k8s.git                        
                        git add k8s/deploy.yaml
                        if git diff --cached --quiet; then
                            echo "No changes to commit in deploy.yaml."
                        else
                            git commit -m "Update image tag to ${tagToDeploy}"
                            git push origin main
                        fi
                        """
                    }
                }
            }
        }
    }
}
