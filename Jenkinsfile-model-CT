pipeline {

  agent {
    kubernetes {
      inheritFrom 'model-ct'
    }
  }

  environment {
    MLFLOW_TRACKING_URI = "https://mlflow-server.c-321a6c0.stage.kyma.ondemand.com"
    MLFLOW_EXPERIMENT_NAME = "diabetes-ct"
    MLFLOW_PROJECT_ENV_MANAGER = "local"
  }

  stages {

    stage('Install Dependencies') {
      steps {
        container('python') {
          sh '''
set -e
pip install --no-cache-dir mlflow scikit-learn pandas numpy joblib argparse
'''
        }
      }
    }

    stage('Ingest Data') {
      steps {
        container('python') {
          script {
            def output = sh(
              script: '''
set -e
export PYTHONPATH=$PWD
python mlops/steps/ingest.py
''',
              returnStdout: true
            ).trim()

            def line = output
          .readLines()
          .find { it.startsWith("TRAIN_RUN_ID=") }

          if (!line) {
            error("TRAIN_RUN_ID not found in train output")
          }

          env.TRAIN_RUN_ID = line.split("=")[1]
          echo "Captured TRAIN_RUN_ID=${env.TRAIN_RUN_ID}"
          }
        }
      }
    }

    stage('Train Model') {
      steps {
        container('python') {
          sh '''        
set -e
export PYTHONPATH=$PWD
python mlops/steps/train.py --train_run_id=$TRAIN_RUN_ID
'''
        }
      }
    }

    stage('Evaluate Model') {
      steps {
        container('python') {
          sh '''        
set -e
export PYTHONPATH=$PWD
python mlops/steps/evaluate.py --train_run_id=$TRAIN_RUN_ID
'''
        }
      }
    }

    
  }
}
