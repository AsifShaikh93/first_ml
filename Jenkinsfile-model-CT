pipeline {

  agent {
    kubernetes {
      inheritFrom 'model-ct'
    }
  }

  environment {
    MLFLOW_TRACKING_URI = "https://mlflow-server.c-321a6c0.stage.kyma.ondemand.com"
    MLFLOW_EXPERIMENT_NAME = "diabetes-ct"
    MLFLOW_PROJECT_ENV_MANAGER = "local"
  }

  stages {

    stage('Install Dependencies') {
      steps {
        container('python') {
          sh '''
set -e
pip install --no-cache-dir mlflow scikit-learn pandas numpy joblib
'''
        }
      }
    }

    stage('Ingest Data') {
      steps {
        container('python') {
          sh '''
set -e  
export PYTHONPATH=$PWD        
mlflow run . -e ingest --env-manager=local
''' 
        }
      }
    }

    stage('Train Model') {
      steps {
        container('python') {
          script {
            def output = sh(
              script: '''
set -e
export PYTHONPATH=$PWD
mlflow run . -e train --env-manager=local
''',
              returnStdout: true
            ).trim()

            def line = output
          .readLines()
          .find { it.startsWith("TRAIN_RUN_ID=") }

          if (!line) {
            error("TRAIN_RUN_ID not found in train output")
          }

          env.TRAIN_RUN_ID = line.split("=")[1]
          echo "Captured TRAIN_RUN_ID=${env.TRAIN_RUN_ID}"
          }
        }
      }
    }

    stage('Evaluate Model') {
      steps {
        container('python') {
          sh '''
set -e
export PYTHONPATH=$PWD
mlflow run . -e evaluate --env-manager=local -P train_run_id=${env.TRAIN_RUN_ID}
'''
        }
      }
    }

    stage('Register Model') {
      steps {
        container('python') {
          sh '''
set -e
export PYTHONPATH=$PWD
mlflow run . -e register --env-manager=local -P train_run_id=${env.TRAIN_RUN_ID} | tee register.out
grep "MODEL_URI=" register.out | cut -d= -f2 > model_uri.txt
'''
        }
      }
    }

    stage('Trigger model-CD Pipeline') {
      steps {
        build job: 'first_ml_new_model_CD',
              parameters: [
                string(name: 'MODEL_URI', value: readFile('model_uri.txt').trim())
              ],
              wait: true
      }
    }
  }
}
