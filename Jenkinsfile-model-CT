pipeline {

  agent {
    kubernetes {
      inheritFrom 'model-ct'
    }
  }

  environment {
    // INSIDE cluster URI (best practice)
    MLFLOW_TRACKING_URI = "http://mlflow:5000"
    MLFLOW_EXPERIMENT_NAME = "diabetes-ct"
  }

  stages {

    stage('Install Dependencies') {
      steps {
        container('python') {
          sh '''
pip install --no-cache-dir mlflow==2.10.2 scikit-learn pandas numpy joblib
'''
        }
      }
    }

    stage('Run MLflow Pipeline (CT)') {
      steps {
        container('python') {
          sh '''
set -e
mlflow pipelines run \
  --pipeline-root mlops \
  --profile local
'''
        }
      }
    }

    stage('Trigger model-CD Pipeline') {
      steps {
        build job: 'first_ml_new_model_CD', wait: true
      }
    }
  }
}