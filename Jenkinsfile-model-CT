pipeline {

  agent {
    kubernetes {
      inheritFrom 'model-ct'
    }
  }

  environment {
    MLFLOW_TRACKING_URI = "http://mlflow:5000"
    MLFLOW_EXPERIMENT_NAME = "diabetes-ct"
  }

  stages {

    stage('Install Dependencies') {
      steps {
        container('python') {
          sh '''
set -e
pip install --no-cache-dir mlflow scikit-learn pandas numpy joblib
'''
        }
      }
    }

    stage('Ingest Data') {
      steps {
        container('python') {
          sh 'mlflow run . -e ingest'
        }
      }
    }

    stage('Train Model') {
      steps {
        container('python') {
          sh 'mlflow run . -e train'
        }
      }
    }

    stage('Evaluate Model') {
      steps {
        container('python') {
          sh 'mlflow run . -e evaluate'
        }
      }
    }

    stage('Register Model') {
      steps {
        container('python') {
          sh '''
set -e
mlflow run . -e register | tee register.out
grep "MODEL_URI=" register.out | cut -d= -f2 > model_uri.txt
'''
        }
      }
    }

    stage('Trigger model-CD Pipeline') {
      steps {
        build job: 'first_ml_new_model_CD',
              parameters: [
                string(name: 'MODEL_URI', value: readFile('model_uri.txt').trim())
              ],
              wait: true
      }
    }
  }
}
