pipeline {

    agent {
       kubernetes {
       inheritFrom 'model-ct'
       }
    }

    environment {
        KFP_ENDPOINT = "https://ml-pipeline-ui-apirule.c-321a6c0.stage.kyma.ondemand.com"
        KFP_TOKEN    = credentials('kubeflow-token')
    }

    stages {

        stage('Install Dependencies') {
            steps {
              container('python') {
                sh '''
pip install --no-cache-dir kfp==2.7.0
'''           }
            }
        }

        stage('Compile Pipeline') {
            steps {
              container('python') {
                sh '''
python3 << 'EOF'
from kfp import compiler
from mlops.pipeline import diabetes_pipeline

compiler.Compiler().compile(
    pipeline_func=diabetes_pipeline,
    package_path="diabetes_pipeline.yaml"
)
EOF
'''             }
            }
        }

        stage('Upload Pipeline (optional)') {
            steps {
              container('python') {
                sh '''
curl -s -X POST \
  "$KFP_ENDPOINT/apis/v1beta1/pipelines/upload" \
  -H "Authorization: Bearer $KFP_TOKEN" \
  -F "uploadfile=@diabetes_pipeline.yaml" || true
'''           }
            }
        }

       stage('Run Pipeline') {
    steps {
      container('python') {
        sh '''
python3 << 'EOF'
import kfp
import os

client = kfp.Client(
    host=os.environ["KFP_ENDPOINT"],
    existing_token=os.environ["KFP_TOKEN"]
)

run = client.create_run_from_pipeline_package(
    pipeline_file="diabetes_pipeline.yaml",
    arguments={},
    run_name=f"diabetes-ct-run-{os.popen('date +%s').read().strip()}"
)
print(f"Run created: {run.run_id}")
EOF
'''
      }
    }
}

       stage('Trigger model-CD Pipeline') {
            steps {
                build job: 'first_ml_new_model_CD', wait: true
            }
       }  
   }
}
