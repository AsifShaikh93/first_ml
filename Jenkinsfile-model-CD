pipeline {

  agent {
       kubernetes {
       inheritFrom 'model-ct'
       }
  }

  environment {
    MLFLOW_TRACKING_URI = "https://mlflow-apirule.c-321a6c0.stage.kyma.ondemand.com"
    MODEL_NAME = "diabetes-model"
  }

  stages {

    stage('Install Dependencies') {
      steps {
          container('python') {
        sh '''

pip install --no-cache-dir mlflow
'''
         }
      }
    }

    stage('Fetch MODEL_URI from MLflow') {
      steps {
          container('python') {
        sh '''
set -e

python3 << 'EOF'
import mlflow
from mlflow.tracking import MlflowClient
import os

mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])
client = MlflowClient()

model_name = os.environ["MODEL_NAME"]

versions = client.search_model_versions(f"name='{model_name}'")

if not versions:
    raise RuntimeError("No registered model versions found")

# Pick latest version (or filter by stage if you want)
latest = sorted(
    versions,
    key=lambda v: int(v.version),
    reverse=True
)[0]

model_uri = f"models:/{model_name}/{latest.version}"

print(f"Selected model URI: {model_uri}")

with open("model_uri.env", "w") as f:
    f.write(f"MODEL_URI={model_uri}")
EOF
'''
          }
       }
    }

    stage('Checkout Repo') {
      steps {
        git branch: 'main',
            credentialsId: 'git-cred',
            url: 'https://github.com/AsifShaikh93/first_ml_k8s.git'
      }
    }

    stage('Update MODEL_URI') {
      steps {
          container('python') {
        sh '''
set -e
source model_uri.env

git config user.name "jenkins-bot"
git config user.email "jenkins@company.com"

echo "Promoting model: $MODEL_URI"

sed -i "s|MODEL_URI:.*|MODEL_URI: \\"$MODEL_URI\\"|" k8s/deploy.yaml

git add k8s/deploy.yaml
git commit -m "Promote ML model $MODEL_URI"
git push origin main
'''
        }
      }
    }
  }
}
