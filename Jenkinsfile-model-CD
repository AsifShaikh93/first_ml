pipeline {

  agent {
       kubernetes {
       inheritFrom 'model-ct'
       }
  }

  environment {
    MLFLOW_TRACKING_URI = "https://mlflow-server.c-321a6c0.stage.kyma.ondemand.com"
    MODEL_URI = "models:/diabetes-model/Production"
  }

  stages {

    stage('Install Dependencies') {
      steps {
          container('python') {
        sh '''

pip install --no-cache-dir mlflow
'''
         }
      }
    }

stage('Verify Production Model Exists') {
      steps {
        container('python') {
          sh '''
python3 << 'EOF'
import mlflow
from mlflow.tracking import MlflowClient
import os

mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])
client = MlflowClient()

model_name = "diabetes-model"

try:
    mv = client.get_model_version_by_alias(model_name, "Production")
except Exception:
    raise SystemExit("❌ No Production model found. Aborting CD.")

print(f"✅ Production model found: v{mv.version}")

EOF
'''
        }
      }
    }

    stage('Checkout Repo') {
      steps {
        git branch: 'main',
            credentialsId: 'git-cred',
            url: 'https://github.com/AsifShaikh93/first_ml_k8s.git'
      }
    }

    stage('Update MODEL_URI') {
      steps {
          container('python') {
        sh '''
set -e
. MODEL_URI.env

git config user.name "jenkins-bot"
git config user.email "jenkins@company.com"

echo "Promoting model: $MODEL_URI"

sed -i "s|MODEL_URI:.*|MODEL_URI: \\"$MODEL_URI\\"|" k8s/deploy.yaml

git add k8s/deploy.yaml
git commit -m "Promote ML model $MODEL_URI"
git push origin main
'''
        }
      }
    }
  }
}
